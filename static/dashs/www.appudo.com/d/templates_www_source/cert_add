{"foot":"<style name=\"stl_cert_add\">\n    #ubox {\n        background:#fff;\n        border-radius:2px;\n        border:1px solid #223560;\n        height:30px;\n        text-align:center;\n        padding-top:5px;\n        cursor:pointer;\n        margin-bottom:20px;\n    }\n    #ubox.drop {\n        background:#b0b0b0;\n    }\n    .ldiv,.pdiv {\n        margin: 7px 10px 5px 10px;\n        display:inline-block; \n    }\n    .ldiv {\n        float:left;\n        overflow: hidden;\n        text-overflow: ellipsis;\n        width:17em;\n    }\n    .pdiv {\n        overflow:hidden; \n        white-space:nowrap; \n        text-overflow: ellipsis;\n        width:80%;\n    }\n    #progOuter {\n        position:relative;\n        padding:0;\n        background:#ffffff;\n        border:1px solid #ddd;\n        border-radius:4px;\n        margin-top:10px;\n        text-align:center;\n        height:30px;\n    }\n    #progPercent {\n        position:absolute;\n        left:0;\n        display: inline-block;\n        line-height: 30px;\n        vertical-align: bottom;\n        width:100%;\n        height:100%;\n        white-space:nowrap;\n        overflow:hidden;\n        text-overflow:ellipsis;\n    }\n    #progInner {\n        position:absolute;\n        left:0;\n        display:inline-block;\n        width:30px;\n        height:100%;\n        padding:0;\n        border-radius:4px;\n        background: #457edb;\n        box-shadow:0 -1px 0 2px #3e6dbb inset, 0 3px 4px rgba(0, 0, 0, 0.3), 0 3px rgba(255, 255, 255, 0.38) inset;\n        -webkit-box-shadow:0 -1px 0 2px #3e6dbb inset, 0 3px 4px rgba(0, 0, 0, 0.3), 0 3px rgba(255, 255, 255, 0.38) inset;\n        -moz-box-shadow:0 -1px 0 2px #3e6dbb inset, 0 3px 4px rgba(0, 0, 0, 0.3), 0 3px rgba(255, 255, 255, 0.38) inset;\n    }\n</style>","body": {"minit":"<script>minit('cert_add',['modalLayer','add_form'], {srefs:['modalLayer','add_form'],sid:'stl_cert_add'});<\/script>","misc":"<script>moduleCtx['cert_add']=function(){\n    return {\n        nosel:true,\n        files:{},\n        cFile:null,\n        progress:null,\n        end:null,\n        unload : function() {\n            this.finish();\n        },\n        finish : function() {\n            if(this.end) {\n                 this.end();\n                 this.end = null;\n            }\n        },\n        doValidate : function(pdata, o, after) {\n            postCredsCross(o, userBase('/server/', o.name), {data:'{\"cmd\":8,\"data\":' + JSON.stringify(JSON.stringify(pdata)) + '}',tk:o.tk}, after);\n        },\n        rstFrm : function(frm) {\n\t\t    enableMain();\n            frm[0].reset();\n        },\n        doError : function(msg) {\n            if(this.remPending)\n                this.remPending();\n            this.finish();\n\t\t    enableMain();\n\t\t    if(msg)\n\t\t        modalError(msg);\n        },\n        validateFrm : function(frm) {\n            var _this = this;\n            var data = frm._sdata || frm.serializeJSON();\n            \n            _this.doRegister.call(_this, data);\n        },\n        showProgress : function (v) {\n            if(v)\n            {\n                $('#progPercent')[0].innerText = '0%';\n                setModal();\n            } else {\n                unsetModal();\n            }\n            \n            $('#theUpload').css('display', v ? 'block' :'none');\n        },\n        setProgress : function(v) {\n            v = Math.round(v);\n            this.progress.p[0].innerText = v + '%';\n            this.progress.i.css('width', Math.round((this.progress.o.width()*v)/100) + 'px');\n        },\t\n        errSubmit : function(data) {\n            var i18n = this.i18n.info;\n            this.doError(i18n.ufail);\n        },\n        finSubmit : function() {\n\t\t    this.setProgress(100);\n\t\t    this.showProgress(false);\n\t\t    this.rstFrm($('#CrtAddFrm'));\n\t\t\tthis.finish();\n        },      \n        doSubmit : function(data, o, rdata) {\n            var _this = this;\n            var i18n = this.i18n.info;\n            var after = function(res) {\n                delete data['upr'];\n                if(res.r == 0) {\n                    _this.doUpload.call(_this, data, o, rdata);\n                } else {\n                    _this.doError(i18n.vfail);\n                }\n            };\n            var hf = _this.files.ssk || _this.files.ssc;\n            if(hf) {\n                _this.doValidate.call(_this, {an:data.an,dn:data.dn,sn:data.sn,on:data.on,se:data.se,eo:data.eo}, o, after);\n            } else {\n                after({r:0});\n            }\n        },\n        doRegister : function(fdata) {\n            var _this = this;\n            var i18n = this.i18n.info;\n            /* register with user dash */\n            var pd = {dn:fdata.dn,ds:fdata.dsc,sn:fdata.sn};\n            if(fdata.ex && fdata.ty) {\n                pd.ex = 0;\n            }\n            postCreds(userBase('/admin/'), {data:'{\"cmd\":28, \"data\":' + JSON.stringify(JSON.stringify(pd)) + '}'}, function(data) {\n                if(data.r == 0) {\n                    if(_this.addPending)\n                        _this.addPending(parseInt(data.id));\n                    if(fdata.nn == '')\n                        fdata.nn = i18n.ukn;\n                    data.nn = fdata.nn;\n                    fdata.on = mainCtx.linfo.m;\n                    fdata.eo = \"1\";\n                    fdata.af = \"1\";\n                    fdata.an = data.n;\n                    fdata.dn = userBaseRaw('', '', data.n);\n                    delete fdata.nn;\n                    \n                    /* do cross login to node */\n                    crossLoginKeep(data.tn, function(d, end) {\n                        _this.end = end;\n                        if(d) {\n                            /* send request to node */\n            \t            _this.doSubmit.call(_this, fdata, d, data);\n                        } else {\n                            _this.doError();\n                        }\n                    });\n                } else {\n                    _this.doError(i18n.rfail);\n                }\n            });\n        },\n        doUpload : function(fdata, o, rdata) {\n            this.setProgress(0);\n            this.showProgress(true);\n            var _this = this;\n\t\t\tvar fd = new FormData();\n\t\t\tfd.append('data', JSON.stringify({cmd:2,data:JSON.stringify(fdata)}));\n\t\t\tfd.append('tk', o.tk);\n\t\t\tconsole.log(this.files);\n\t\t\tif(this.files.ssk) {\n\t\t\t    fd.append('name', 'ssk');\n\t\t\t    fd.append('ssk', this.files.ssk);\n\t\t\t}\n\t\t\tif(this.files.ssc) {\n\t\t\t    fd.append('name', 'ssc');\n\t\t\t    fd.append('ssc', this.files.ssc);\n\t\t\t}\n\t        var xhr = new XMLHttpRequest();\n\t        var stop = $('#abt');\n            \n            stop.unbind('click');\n            stop.click(function(e) {\n                e.preventDefault(); \n                xhr.abort();\n            });\n            \n\t        xhr.upload.addEventListener('progress', function(e) {\n\t        \tif(e.lengthComputable) {\n\t        \t\tvar p = (e.loaded * 100 / (e.total));\n\t        \t\t_this.setProgress.call(_this, p);\n\t        \t}\n\t        }, false);\n\t        \n\t        var doPost = function() {\n                xhr.open('POST', userBase('/server/', o.name), true);\n    \t        xhr.send(fd);\n\t        }\n\t        \n\t        xhr.addEventListener('load', function() {\n\t            var response = {r:-1};\n\t\t\t\tvar ioArgs = xhr.ioArgs;\n\t            if(xhr.status == 200) {  \n\t                var response = validateRes(xhr.responseText, true);\n                    if(!response) {\n                        _this.doError();\n                        return;\n                    }\n\t            }\n\t\t\t\tif(response.r != 0)\n\t\t\t\t{\n\t\t\t\t    if(response.l) {\n                        crossLogin(o.id, function(d) {\n                            if(d) {\n                                o = d;\n                                fd.set('tk', o.tk);\n\t\t\t\t                doPost();\n                            } else {\n                                _this.doError();\n                            }\n                        }, true);\n\t\t\t\t        return;\n\t\t\t\t    }\n\t\t\t\t    _this.errSubmit.call(_this, response);\n\t\t\t\t} else {\n\t\t\t        _this.finSubmit.call(_this);\n                    if(_this.onAdd) {\n                        _this.onAdd(fdata, rdata);\n                    }\n\t\t\t\t}\n\t        }, false);\n\t        xhr.addEventListener('error', function() {\n\t\t        _this.errSubmit.call(_this);\n\t        }, false);\n\t        xhr.addEventListener('abort', function() {\n\t\t        enableMain();\n                if(_this.remPending)\n                    _this.remPending();\n\t\t\t\t_this.showProgress.call(_this, false);\n\t        }, false);\n\t        \n\t        doPost();\n        },\n    \thandleFiles : function(items, idx) {\n        \tvar _this = this;\n            var i18n = this.i18n.info;\n    \t    if(items) {\n    \t        if(idx < items.length) {\n        \t        var theFile = $('#theFile');\n        \t        var file = items[idx];\n        \t        cFile = file;\n    \t            theFile.off('onFileReady');\n    \t            theFile.on('onFileReady', function() {\n    \t                _this.handleFiles.call(_this, items, idx + 1);\n                    });\n        \t        $('#theFile').css('display', 'block');\n        \t        setModal();\n        \t        $('#flval').text(file.name);\n    \t        }\n    \t    } else {\n                _this.doError(i18n.ffail);\n    \t    }\n    \t},\n        parseFileList : function(list) {\n            var info = {};\n            var result = [];\n\t\t\tfor(var i = 0, len = list.length; i < len; i++) {\n\t\t\t\tif(list[i].webkitGetAsEntry && list[i].kind=='file') {\n\t\t\t\t\tvar item = list[i].webkitGetAsEntry();\n\t\t\t\t\tif(item) {\n\t\t\t\t\t\tthis.parseFiles(info, item,result);\n\t\t\t\t\t\tif(info.error)\n\t\t\t\t\t\t    return null;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn info.error ? null : result;\n\t\t},\n    \tparseFiles : function(info, item, result) {\n        \tvar _this = this;\n    \t    if(info.error)\n    \t        return;\n\t\t\tif(item.isFile) {\n\t\t\t    result.push(item);\n\t\t\t} else \n\t\t\tif(item.isDirectory) {\n\t\t\t\tvar rd = item.createReader();\n\t\t    \trd.readEntries(function(items, a) {\n\t\t\t\t\tif(items.length != 0) {\n    \t\t\t\t\tvar l = [];\n    \t\t\t\t\tfor(var i = 0, len = items.length; i< len; i++) {\n    \t\t\t\t\t    _this.parseFiles(info, items[i], result);\n    \t\t\t\t\t    if(info.error)\n    \t\t\t\t\t        return;\n    \t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}, function(){\n\t\t\t\t    info.error = true;\n\t\t\t\t    /* doUploadEnd(info);  */\n\t\t\t\t});\n\t\t\t}\n\t\t},\n\t\tupdFiles : function() {\n\t\t    var ck = this.files.ssk;\n\t\t    var cc = this.files.ssc;\n\t\t    var no = this.i18n.frm.no;\n\t\t    $('#ck').text(ck ? ck.name : no);\n\t\t    $('#cc').text(cc ? cc.name : no);\n\t\t},\n        hide : function() {\n            this.onUnload(true);\n        },\n        dmnClose : function(e) {\n            var _this = e.data.ctx;\n            if ($(e.target).closest(\"#dmnSearch\").length === 0 && e.target != $('#dmnBtn')[0]) {\n                $(document).off('click', _this.dmnClose);\n                _this.showSearch('dmn', true);\n            }\n        },\n        sslClose : function(e) {\n            var _this = e.data.ctx;\n            if ($(e.target).closest(\"#sslSearch\").length === 0 && e.target != $('#sslBtn')[0]) {\n                $(document).off('click', _this.sslClose);\n                _this.showSearch('ssl', true);\n            }\n        },\n        showSearch : function(ty, off) {\n            var s = $('#' + ty + 'Search');\n            \n            if(!s.hasClass('block')) {\n                s.toggleClass('block');\n                $(document).on('click', {ctx:this}, this[ty + 'Close']);\n                var b = $('#' + ty + 'Btn');\n                var bo = b.offset();\n                s.css('left', bo.left);\n                s.css('top', bo.top + b.outerHeight());\n                if(s.offset().left + s.outerWidth() > $(window).width()) {\n                    s.css('left', bo.left + b.outerWidth() - s.width());\n                }\n                $('#' + ty + 'Input').focus();\n            }\n            \n            if(off)\n                s.toggleClass('block');\n        },\n        filterSearch : function(ty) {\n            console.log('filter')\n            var input, filter, ul, li, a, i;\n            input = $('#' + ty + 'Input');\n            filter = input.val().toUpperCase();\n            div = $('#' + ty + 'Search');\n            a = div[0].getElementsByTagName(\"a\");\n            for (i = 0; i < a.length; i++) {\n                if (a[i].innerHTML.toUpperCase().indexOf(filter) > -1) {\n                    a[i].style.display = \"\";\n                } else {\n                    a[i].style.display = \"none\";\n                }\n            }\n        },\n        run : function() {\n            var _this = this; \n            var i18n = this.i18n.info;\n            var frm = $('#CrtAddFrm');\n            var theFile = $('#theFile');\n            this.progress = {o:$('#progOuter'),i:$('#progInner'),p:$('#progPercent')};\n               \n            $('#abrt').click(function(){_this.hide.call(_this);});\n            $('#dmnBtn').click(function(e){_this.showSearch.call(_this, 'dmn');});\n            $('#sslBtn').click(function(e){_this.showSearch.call(_this, 'ssl');});\n            $('#dmnSBtn').click(function(){_this.filterSearch.call(_this, 'dmn');});\n            $('#sslSBtn').click(function(){_this.filterSearch.call(_this, 'ssl');});\n            \n            handleError(frm, function() {\n\t\t        disableMain();\n                _this.validateFrm.call(_this, frm);\n            }, '', function() {\n                var errs = [];\n                var data = frm[0]._sdata || frm.serializeJSON();\n                frm[0]._sdata = data;\n                \n                var lbl;\n                \n                if(data.up != data.upr) {\n    \t            lbl = $('label[for=upr]').text();\n                    errs.push({i:$('#upr'),l:lbl, m:i18n.epwm});\n                }\n                if(data.di && data.ds == '') {\n    \t            lbl = $('label[for=ds]').text();\n                    errs.push({i:$('#ds'),l:lbl, m:i18n.edsk});\n                }\n                if(data.se && data.sn == '') {\n    \t            lbl = $('label[for=se]').text();\n                    errs.push({i:$('#se'),l:lbl, m:i18n.essln});\n                }\n                if(data.se) {\n                    if(!data.sc && (!_this.files.ssk || !_this.files.ssc)) {\n                        if(!_this.files.ssk) {\n            \t            lbl = $('label[for=ck]').text();\n                            errs.push({i:$('#ssk'),l:lbl, m:i18n.esslf});\n                        }\n                        if(!_this.files.ssc) {\n            \t            lbl = $('label[for=cc]').text();\n                            errs.push({i:$('#ssk'),l:lbl, m:i18n.esslf});\n                        }\n                    }\n                } else\n                if(_this.files.ssk || _this.files.ssc) {\n                    if(_this.files.ssk) {\n        \t            lbl = $('label[for=ck]').text();\n                        errs.push({i:$('#ssk'),l:lbl, m:i18n.esslnf});\n                    }\n                    if(_this.files.ssc) {\n        \t            lbl = $('label[for=cc]').text();\n                        errs.push({i:$('#ssk'),l:lbl, m:i18n.esslnf});\n                    }\n                }\n                \n                if(data.eo && data.on == '') {\n    \t            lbl = $('label[for=on]').text();\n                    errs.push({i:$('#on'),l:lbl, m:i18n.eon});\n                }\n                \n                return errs;\n            });\n            \n            var cluf = function() {\n                theFile.css('display', 'none');\n                unsetModal();\n                cFile = null;\n                _this.updFiles.call(_this);\n    \t        theFile.trigger('onFileReady');\n            }\n            $('#ssk').click(function(e) {\n                e.preventDefault(); \n                _this.files.ssk = cFile;\n                cluf();\n            });\n            $('#ssc').click(function(e) {\n                e.preventDefault(); \n                _this.files.ssc = cFile;\n                cluf();\n            });\n            $('#non').click(function(e) {\n                e.preventDefault(); \n                cluf();\n            });\n            \n            var dropBox = $('#ubox');  \n            \n            var file = $('input[type=\"file\"]');\n            file.on('change', function(e) {\n                _this.handleFiles.call(_this, file[0].files, 0);\n            });\n            dropBox.on('click', function() {\n                file.trigger('click');\n            });\n            \n            dropBox[0].ondrop = function(e) {\n                e.preventDefault();  \n                dropBox.removeClass('drop');\n                if(!e.dataTransfer) {\n                    return false;\n                }\n                var items;\n                if ((items = e.dataTransfer.items)) {\n                } else \n                if((items = e.dataTransfer.files)){\n                } else {\n                    return false;\n                }\n                \n                var farr = _this.parseFileList.call(_this, items);\n                \n                var fileData = function(items, idx, result, after) {\n                    if(idx < items.length) {\n        \t\t\t    items[idx].file(function(file) {\n        \t\t\t        result.push(file);\n    \t\t\t\t\t    fileData(items, idx + 1, result, after);\n    \t\t\t\t\t}, function(){\n    \t\t\t\t\t    after(null);\n    \t\t\t\t\t});\n                    } else {\n                        after(result);\n                    }\n                }\n                \n                fileData(farr, 0, [], function(r) {\n                    _this.handleFiles.call(_this, r, 0);\n                });\n                \n            } \n            \n            dropBox[0].ondragover = function(e) {\n                e.preventDefault();\n                dropBox.addClass('drop');\n            }\n            \n            dropBox[0].ondragleave = function(e) {\n                e.preventDefault();\n                dropBox.removeClass('drop');\n            }\n        }\n    }\n}();<\/script>","modalLayer":"<div id=\"theUpload\" style=\"display:none;\" class=\"modal\" tabindex=\"-1\" role=\"dialog\" aria-labelledby=\"uploadModal\" aria-hidden=\"true\"><div class=\"dlg\"><div class=\"ltop\"><span>{{prg.lbl}}<\/span><\/div><div><div id=\"progOuter\"><div id=\"progInner\"><\/div><span id=\"progPercent\"><\/span><\/div><\/div><div style=\"clear:both;\"><\/div><div class=\"frm btn\" style=\"margin-right:0;\"><button style=\"float:right;\" type=\"button\" name=\"abt\" id=\"abt\">{{prg.abt}}<\/button><\/div><\/div><\/div><div id=\"theFile\" style=\"display:none;\" class=\"modal\" tabindex=\"-1\" role=\"dialog\" aria-labelledby=\"fileModal\" aria-hidden=\"true\"><div class=\"dlg\"><div class=\"ltop\"><span>{{afl.sel}}<\/span><\/div><div class=\"frm btn\"><div style=\"display:inline-block;margin-top:-10px;width:100%;\"><label style=\"display:inline-block;overflow: hidden;\">{{afl.fl}}:<\/label><div id=\"flval\" class=\"pdiv\"><\/div><\/div><div style=\"clear:both;\"><\/div><button type=\"button\" name=\"ssk\" id=\"ssk\">{{afl.key}}<\/button><span style=\"width:20px;display:inline-block;\"><\/span><button type=\"button\" name=\"ssc\" id=\"ssc\">{{afl.crt}}<\/button><span style=\"width:20px;display:inline-block;\"><\/span><button type=\"button\" name=\"non\" id=\"non\">{{afl.non}}<\/button><\/div><\/div><\/div>","add_form":"<div class=\"htop\"><h1>{{info.add}}<\/h1><\/div><div class=\"frmBox\"><div id=\"sslSearch\" class=\"searchContent\"><form onsubmit=\"return false;\" class=\"frm\"><div><input type=\"text\" placeholder=\"{{frm.ssrh}}\" id=\"sslInput\" class=\"search\"><button type=\"submit\" id=\"sslSBtn\">{{frm.srh}}<\/button><\/div><\/form><a href=\"#about\">About<\/a><a href=\"#base\">Base<\/a><a href=\"#blog\">Blog<\/a><a href=\"#contact\">Contact<\/a><a href=\"#custom\">Custom<\/a><a href=\"#support\">Support<\/a><a href=\"#tools\">Tools<\/a><\/div><div id=\"dmnSearch\" class=\"searchContent\"><form onsubmit=\"return false;\" class=\"frm\"><div><input type=\"text\" placeholder=\"{{frm.dsrh}}\" id=\"dmnInput\" class=\"search\"><button type=\"submit\" id=\"dmnSBtn\">{{frm.srh}}<\/button><\/div><\/form><a href=\"#about\">About<\/a><a href=\"#base\">Base<\/a><a href=\"#blog\">Blog<\/a><a href=\"#contact\">Contact<\/a><a href=\"#custom\">Custom<\/a><a href=\"#support\">Support<\/a><a href=\"#tools\">Tools<\/a><\/div><form id=\"CrtAddFrm\" class=\"frm min\"><div class=\"box1\" style=\"float:left;\"><label for=\"se\">{{frm.se}}<\/label><input type=\"checkbox\" id=\"se\" name=\"se\" value=\"se\"><label for=\"sn\">{{frm.sn}}*:<\/label><div class=\"searchFrame\" style=\"float:right;\"><button id=\"sslBtn\" class=\"searchBtn\" type=\"button\">▼<\/button><\/div><input style=\"width:16em;\" type=\"text\" id=\"sn\" name=\"sn\" required=\"\"><label for=\"dn\">{{frm.dn}}*:<\/label><div class=\"searchFrame\" style=\"float:right;\"><button id=\"dmnBtn\" class=\"searchBtn\" type=\"button\">▼<\/button><\/div><input style=\"width:16em;\" type=\"text\" id=\"dn\" name=\"dn\" pattern=\"^([a-zA-Z0-9]([a-zA-Z0-9\\-]{0,61}[a-zA-Z0-9])?\\.)+[a-zA-Z]{2,6}$\" required=\"\"><label for=\"dsc\">{{frm.dsc}}:<\/label><div style=\"margin:0 10px 0 10px;\"><textarea id=\"dsc\" name=\"dsc\" style=\"height:90px\"><\/textarea><\/div><\/div><div class=\"box2\" style=\"float:left;\"><div style=\"clear:both;margin-bottom:5px;\"><\/div><input type=\"file\" style=\"display: none\"><div id=\"ubox\">\n                        {{frm.drop}}\n                    <\/div><label for=\"cc\">{{frm.cc}}:<\/label><div id=\"cc\" class=\"ldiv\">{{frm.no}}<\/div><label for=\"ck\">{{frm.ck}}:<\/label><div id=\"ck\" class=\"ldiv\">{{frm.no}}<\/div><label for=\"sc\">{{frm.sc}}<\/label><input type=\"checkbox\" id=\"sc\" name=\"sc\" value=\"sc\"><label for=\"ex\">{{frm.ex}}:<\/label><select id=\"ty\" name=\"ty\" style=\"width:6em;float:right;margin:5px 0 5px 0;\"><option>{{frm.dy}}<\/option><option>{{frm.mo}}<\/option><option>{{frm.yr}}<\/option><\/select><input type=\"text\" id=\"ex\" name=\"ex\" style=\"width:12em;\" pattern=\"[0-9]*\"><div style=\"clear:both;\"><\/div><div style=\"margin-top:55px;\"><input type=\"submit\" style=\"float:right;margin-top:10px;margin-right:10px\" value=\"{{frm.sub}}\"><input type=\"button\" id=\"abrt\" style=\"float:right;margin-top:10px;margin-right:10px\" value=\"{{frm.cls}}\"><\/div><\/div><\/form><div style=\"clear:both;\"><\/div><\/div>"}}