!function(){window.Differ=function(t,e){var n=e&&void 0!==e.log?function(){console.log.apply(null,arguments)}:function(){},r={onFocus:function(){},onBlur:function(){},textChanged:function(){},textSaved:function(t){this.finishSave()},fullUndo:function(){}},s=t.getSession(),a=!1;function h(){a=!1,t.setReadOnly(!1)}var o=!1,u=!1,l=!1,_=!1,d=null,f="",c=null,g=[],v=null,p=s.getUndoManager(),N=t.textInput,w=N.focus;N.focus=function(){r.onFocus.call(r),w.call(this)};var m=N.blur;N.blur=function(){r.onBlur.call(r),m.call(this)},t.container.addEventListener("keydown",function(t){if(t.ctrlKey||t.metaKey)switch(String.fromCharCode(t.which).toLowerCase()){case"s":u&&!a||(t.stopPropagation(),t.preventDefault())}},!0),p.constructor.prototype.execute=function(t){var e=t.args[0];if(this.$doc=t.args[1],0!=this.$redoStack.length){var n=this.$redoStack.indexOf(v);if(-1!=n){var r=this.$undoStack.length;v=0==r?null:this.$undoStack[r-1],g=g.concat(this.$redoStack.slice(n))}this.$redoStack=[]}this.$undoStack.push(e)};var y=function(){this._data=null,this._dataSize=0,this._dataPos=0,this._tmp=new Uint8Array(new ArrayBuffer(10)),this.size=function(){return this._dataPos},this.addData=function(t){if(this._dataPos+t>=this._dataSize){var e=this._dataSize+(1024+(t>>10<<10)),n=new Uint8Array(new ArrayBuffer(e));null!=this._data&&n.set(this._data),this._data=n,this._dataSize=e}this._dataPos+=t},this.writeUint8=function(t){var e=this._tmp;e[0]=t,this.write(e,1)},this.calcLen=function(t){var e=10;do{--e,t>>=7}while(0!=t);return 10-e},this.writeString=function(t){for(var e=this._dataPos,n=0;n<t.length;n++){var r=t.charCodeAt(n);r<=127?(this.addData(1),this._data[e++]=r):r<=2047?(this.addData(2),this._data[e++]=192|r>>6&31,this._data[e++]=128|63&r):(this.addData(3),this._data[e++]=224|r>>12&15,this._data[e++]=128|r>>6&63,this._data[e++]=128|63&r)}},this.writeInt=function(t){var e=this._tmp,n=10;do{e[--n]=127&t|128,t>>=7}while(0!=t);return e[9]&=127,this.write(e.subarray(n,10),10-n),10-n},this.write=function(t,e){if(0!=e){var n=this._dataPos;this.addData(e),this._data.set(t.subarray(0,e),n)}},this.getData=function(){return this._data},this.getResult=function(){return this._data?this._data.subarray(0,this.size()):null}},P=function(){this._insertType=2,this._firstNode=null,this._currentNode=null,this._currentPos=0,this._tmp={line:0,range:0},this._Node=function(){this.prev=null,this.next=null,this.type=0,this.range=0},this._print=function(t){return 1==t.type?"[R, "+t.range+"]":2==t.type?"[N, "+t.range+"]":3==t.type?"[RN, "+t.range+"]":"[NONE, "+t.range+"]"},this._remove=function(t){var e=t.next,n=t.prev;n&&(n.next=e),e&&(e.prev=n),t===this._firstNode&&(this._firstNode=e)},this._insertAfter=function(t,e){var n=t.next;t.next=e,e.prev=t,e.next=n,n&&(n.prev=e)},this._addBreak=function(t,e){var n=e.item;if(null==n&&(n=new this._Node,this._firstNode=n,this._currentNode=n,e.item=n,n.type=t),n.type==t)n.range++;else{var r=new this._Node;this._insertAfter(n,r),r.type=t,r.range++,e.item=r}},this._nextPos=function(t,e){return this._currentPos+t.range},this._prevPos=function(t,e){return this._currentPos-e.range},this._moveRight=function(){var t=this._currentNode,e=t.next;null!=e&&(this._currentNode=e,this._currentPos=this._nextPos(t,e))},this._moveLeft=function(){var t=this._currentNode,e=t.prev;null!=e&&(this._currentNode=e,this._currentPos=this._prevPos(t,e))},this._findPos=function(t){var e=this._currentNode;if(null!=e){for(;t>this._currentPos;){var n=e.next;if(null==n)return;var r=this._nextPos(e,n);if(r>=t)return;e=n,this._currentNode=e,this._currentPos=r}for(;t<=this._currentPos;){var i=e.prev;if(null==i)return;var s=this._prevPos(e,i);e=i,this._currentNode=e,this._currentPos=s}}},this.clear=function(){for(var t=this._firstNode;null!=t;){var e=t;t=t.next,this._remove(e)}this._firstNode=null,this._currentNode=null,this._currentPos=0,this._tmp||(this._tmp={line:0,range:0})},this._copyNode=function(t,e){e.type=t.type,e.range=t.range},this.copy=function(t){this.clear();for(var e=t._firstNode,n=null;null!=e;){var r=new this._Node;this._copyNode(e,r),null==n?(n=r,this._firstNode=r,this._currentNode=r,this._currentPos=0):(this._insertAfter(n,r),n=r),e=e.next}},this._getSize=function(t){switch(t){case 1:case 2:return 1;case 3:return 2;default:return 0}},this._getData=function(t){switch(t){case 1:return"\r";case 2:return"\n";case 3:return"\r\n";default:return""}},this.getData=function(t){return this._getData(this.getType(t))},this.getType=function(t){this._findPos(t);var e=this._currentNode;return null==e||this._currentPos+e.range<t?0:e.type},this.getSize=function(t){return this._getSize(this.getType(t))},this.insertAt=function(t,e){if(null==this._currentNode)return(s=new this._Node).type=this._insertType,s.range=e,this._firstNode=s,this._currentNode=s,void(this._currentPos=0);this._findPos(t);var n=this._currentNode,r=this._currentPos;if(n.type==this._insertType)n.range+=e;else if(t==r+1){var i=n.prev;i&&i.type==this._insertType?(this._moveLeft(),i.range+=e):((s=new this._Node).type=n.type,s.range=n.range,this._insertAfter(n,s),n.type=this._insertType,n.range=e)}else{var s,a=t-r-1,h=n.range;n.range=a,(s=new this._Node).type=this._insertType,s.range=e,this._insertAfter(n,s);var o=new this._Node;o.type=n.type,o.range=h-a,this._insertAfter(s,o)}},this._del=function(t){var e=this._currentNode;if(null!=e){var n=this._currentPos+1,r=e.range-t.line+n;if(r=t.range>r?r:t.range,t.range-=r,t.line==n){if(e.range==r){var i=e.prev,s=e.next,a=!0;return i?this._moveLeft():(this._currentNode=s,this._currentPos=0,a=!1),this._remove(e),a}e.range-=r}else e.range-=r;return null==e.next&&0!=t.range&&(1!=e.range?e.range--:e==this._firstNode?(this._firstNode=null,this._currentNode=null,this._currentPos=0):(this._moveLeft(),this._remove(e)),t.range=0),!0}t.range=0},this.deleteAt=function(t,e){var n=this._tmp;for(n.line=t,n.range=e,this._findPos(t);0!=n.range;)this._del(n)&&0!=n.range&&this._moveRight()},this.setup=function(t){this.clear();for(var e=t.match(/\n|\r\n|\r/g),n={item:null},r=0,i=null==e?0:e.length;r<i;r++){var s=e[r];"\r"==s?this._addBreak(1,n):"\n"==s?this._addBreak(2,n):this._addBreak(3,n)}},this.printNodes=function(){n("print breaks:");for(var t=!0,e=this._firstNode,r="";null!=e;)t?t=!1:r+=", ",r+=this._print(e),e=e.next;n(r)}},x=new function(){this._breaks=new P,this._firstNode=null,this._currentNode=null,this._currentPos=0,this._tmp={line:0,range:0},this._Node=function(){this.prev=null,this.next=null,this.after=0,this.range=0,this.dist=0,this.altered=!1},this._print=function(t){return t.altered?"[a, "+t.after+", "+t.range+", "+t.dist+"]":"[n, "+t.after+", "+t.range+", "+t.dist+"]"},this._remove=function(t){var e=t.next,n=t.prev;n&&(n.next=e),e&&(e.prev=n),t===this._firstNode&&(this._firstNode=e)},this._insertBefore=function(t,e){var n=t.prev;t.prev=e,e.next=t,e.prev=n,n&&(n.next=e),t===this._firstNode&&(this._firstNode=e)},this._insertAfter=function(t,e){var n=t.next;t.next=e,e.prev=t,e.next=n,n&&(n.prev=e)},this._nextPos=function(t,e){return this._currentPos+t.range+t.dist},this._prevPos=function(t,e){return this._currentPos-e.range-e.dist},this._moveRight=function(){var t=this._currentNode,e=t.next;null!=e&&(this._currentNode=e,this._currentPos=this._nextPos(t,e))},this._moveLeft=function(){var t=this._currentNode,e=t.prev;null!=e&&(this._currentNode=e,this._currentPos=this._prevPos(t,e))},this._peekNode=function(t){var e=this._currentNode;if(null!=e){for(;t>this._currentPos;){var n=e.next;if(null==n)return;var r=this._nextPos(e,n);if(r>=t)return;e=n,this._currentNode=e,this._currentPos=r}for(;t<=this._currentPos;){var i=e.prev;if(null==i)return;var s=this._prevPos(e,i);e=i,this._currentNode=e,this._currentPos=s}}},this._insLines=function(t,e){this._breaks.insertAt(t,e),this._peekNode(t);var n=this._currentNode,r=this._currentPos,i=r+n.range,s=(n.dist,function(){n.dist+=e});if(t<=r);else if(t<=i){var a=new this._Node;if(a.type=n.type,a.altered=n.altered,a.range=i-t+1,a.dist=n.dist,n.dist=e,n.range-=a.range,a.after=n.after+n.range,this._insertAfter(n,a),0==n.range){var h=n.prev;h&&(this._moveLeft(),h.dist+=n.dist,this._remove(n))}}else s()},this._del=function(t){var e=this._currentNode,n=this._currentPos,r=n+e.range,i=r+e.dist,s=this,a=function(){if(0==e.range&&0==e.dist){var t=e.prev,n=e.next;if(!t)return s._currentNode=n,s._currentPos=0,s._remove(e),n||s.reset(0),!1;s._moveLeft(),s._remove(e)}return!0};if(t.line<=n);else{if(t.line<=r){var h=t.range,o=t.line+t.range-1,u=0;if(o>r&&0!=e.dist&&(l=(l=o-r)>e.dist?e.dist:l,t.range-=l,e.dist-=l),o>i&&(u=o-i),o<r){var l=r-o,_=new this._Node;_.type=e.type,_.altered=e.altered,_.range=l,e.range-=l,_.after=e.after+e.range,_.dist=e.dist,e.dist=0,this._insertAfter(e,_)}return l=t.range-u,l=e.range>l?l:e.range,e.range-=l,t.range-=l,t.line=i+1-(h-t.range),a()}if(t.line<=i)return l=i-t.line+1,h=t.range,t.range=l>t.range?0:t.range-l,e.dist-=h-t.range,t.line=i+1-l,a();t.range=0}return!0},this._delLines=function(t,e){this._breaks.deleteAt(t,e);var n=this._tmp;for(n.line=t,n.range=e,this._peekNode(t);0!=n.range;)this._del(n)&&0!=n.range&&this._moveRight()},this._alt=function(t){var e=this._currentNode,n=this._currentPos,r=n+e.range,i=r+e.dist,s=function(){var e=i-t.line+1,n=t.range;t.range=e>t.range?0:t.range-e,t.line+=n-t.range};if(t.line<=n);else if(t.line<=r){var a=null;if(!e.altered){var h=t.line+t.range-1<r;if(t.line==n+1)e.altered=!0,a=e;else{var o=new this._Node,u=r-t.line+1;e.range-=u,o.dist=e.dist,e.dist=0,o.altered=!0,o.range=u,o.after=e.after+e.range,this._insertAfter(e,o),a=o;var l=o.next;!h&&l&&0==o.dist&&l.altered&&o.after+o.range==l.after?(o.dist=l.dist,o.range+=l.range,this._remove(l)):this._moveRight()}if(h){(o=new this._Node).altered=!1,o.range=r-t.line-t.range+1,a.range-=o.range,o.after=a.after+a.range,o.dist=a.dist,a.dist=0,this._insertAfter(a,o),this._moveRight();var _=a.prev;_&&0==_.dist&&_.altered&&_.after+_.range==a.after?(_.range+=a.range,this._remove(a)):this._moveRight()}}s()}else t.line<=i?s():t.range=0},this._altLines=function(t,e){var n=this._tmp;for(n.line=t,n.range=e,this._peekNode(t);0!=n.range;)this._alt(n),0!=n.range&&this._moveRight()},this._handle=function(t,e,n,r){for(i=e;i<n;i++)for(var s=t[i],a=s.length,h=0;h<a;h++){var o=s[r?a-h-1:h],u=o.start,l=o.end,_=(u.column,l.column,u.row),d=(l.row,o.action);switch(r&&(d="insert"==d?"remove":"insert"),d){case"insert":_+=1,1!=o.lines.length&&this._insLines(_+1,o.lines.length-1),this._altLines(_,1);break;case"remove":_+=1,1!=o.lines.length&&this._delLines(_+1,o.lines.length-1),this._altLines(_,1)}}},this._utf8length=function(t){for(var e=0,n=0;n<t.length;n++){var r=t.charCodeAt(n);e+=r<=127?1:r<=2047?2:3}return e},this.result=function(t,e){var r=p.$undoStack,i=p.$redoStack,s=new P;s.copy(this._breaks),0!=g.length&&this._handle(g,0,g.length,!0);var a=r.indexOf(v);-1!=a?(a++,this._handle(r,a,r.length,!1)):-1!=(a=i.indexOf(v))?this._handle(i,a,i.length,!0):this._handle(r,0,r.length,!1);var h=new y;if(null==e||1==e.length&&0==e[0].length)return this._breaks.clear(),this.reset(0),h;this._breaks.printNodes(),this.printNodes();var o=new y,u=new y,l=new y,_=this._firstNode,d=0,f=0,c=0,N=this,w=function(e){for(;c<e;)f+=N._utf8length(t[c++]),f+=N._utf8length(s.getData(c))},m=0;w(_.after);for(var x=f;_;){var k=_.altered;if(0!=_.range)if(k){for(var S=0,L=d;L<d+_.range;L++){S+=R=this._utf8length(e[L]),o.writeString(e[L]);var z=this._breaks.getType(L+1);S+=this._utf8length(this._breaks._getData(z)),o.writeString(this._breaks._getData(z))}n("changed: newline("+(d+1)+"), lines("+_.range+"), size("+S+")\n"),S<=17?0!=S&&u.writeUint8(1+S):(u.writeUint8(1),u.writeInt(S)),m+=S}else{w(_.after);var b=f;w(_.after+_.range);var A=f-1;S=A-b+1,n("copy: oldline("+(_.after+1)+"), lines("+_.range+"), size("+S+") - "+b+" to "+A+"\n"),S>=4&&S<=18?(u.writeUint8(20+S-4),l.writeInt(b-x)):(u.writeUint8(19),u.writeInt(S),l.writeInt(b-x)),m+=S}if(_.dist){S=0;var D=null==_.next,U=!0;for(L=d+_.range;L<d+_.range+_.dist;L++){var R=this._utf8length(e[L]);z=this._breaks._insertType,S+=R,D||o.writeString(e[L]),U&&D?U=!1:(S+=this._utf8length(this._breaks._getData(z)),o.writeString(this._breaks._getData(z))),D&&o.writeString(e[L])}n("inserted: newline("+(d+_.range+1)+"), lines("+_.dist+"), size("+S+")\n"),S<=17?0!=S&&u.writeUint8(1+S):(u.writeUint8(1),u.writeInt(S)),m+=S}d+=_.range+_.dist,_=_.next}h.addData(5);var I=h.getData();I[0]=214,I[1]=195,I[2]=196,I[3]=0,I[4]=0,h.writeUint8(1),h.writeInt(f-x),h.writeInt(x);var T=1;return T+=h.calcLen(m),T+=h.calcLen(o.size()),T+=h.calcLen(u.size()),T+=h.calcLen(l.size()),h.writeInt(o.size()+u.size()+l.size()+T),h.writeInt(m),h.writeUint8(0),h.writeInt(o.size()),h.writeInt(u.size()),h.writeInt(l.size()),h.write(o.getData(),o.size()),h.write(u.getData(),u.size()),h.write(l.getData(),l.size()),h},this.setupBreaks=function(t){this._breaks.setup(t)},this.reset=function(t){n("reset");var e=new this._Node;e.altered=!1,e.range=t,this._currentPos=0,this._firstNode=e,this._currentNode=e},this.printNodes=function(){n("print change:");for(var t=!0,e=this._firstNode,r="";null!=e;)t?t=!1:r+=", ",r+=this._print(e),e=e.next;n(r)}};function k(){r.textChanged.call(r,u)}s.on("change",function(t){!o||_||a||(_=!0,l=!0,setTimeout(function(){var t=u;c==p.$undoStack[p.$undoStack.length-1]?(u=!1,t&&r.fullUndo.call(r)):u||(u=!0),t!=u&&k(),_=!1,l=!1},200))}),r.abortSave=function(){h()},r.finishSave=function(){u=!1,k(),h()},r.save=function(){return!(a||!u||(a=!0,t.setReadOnly(!0),r.textSaved.call(r,function(){o=!1;var t=s.getLines(0,s.getLength());f=x.result(d,t),n(f);var t=s.getLines(0,s.getLength());return d=t,x.reset(s.getLength()),v=c=p.$undoStack[p.$undoStack.length-1],g=[],o=!0,{r:f,t:s.getValue()}}()),0))};var S=s.setValue;return s.setValue=r.setText=function(e){o=!1,S.call(s,e),p.reset(),x.reset(s.getLength()),x.setupBreaks(e),g=[],v=c=null,d=s.getLines(0,s.getLength()),o=!0,u=!1,t.scrollToLine(0,!1),t.focus(),k()},r.inChange=function(){return l},r.hasUndo=function(){return p.hasUndo()},r.hasRedo=function(){return p.hasRedo()},r.changed=function(){return u},r.blocked=function(){return a},r.started=function(){return o},t.commands.addCommand({name:"Save",bindKey:{win:"Ctrl-S",mac:"Command-S",sender:"editor"},exec:r.save}),r.go&&(r.go(),r.go=null),r.loaded=!0,r}}();